# - hosts: serverA
#   become: true
#
#   pre_tasks:
#   - name: update apt if applicable
#     apt:
#       update_cache: yes
#       cache_valid_time: 3600
#
#   tasks:
#   - debug: msg="update rsyslog"

- hosts: srv-mon
  become: true

  pre_tasks:
  - name: update apt if applicable
    apt:
      update_cache: yes
      cache_valid_time: 3600
    changed_when: False

  - name: set hostname
    hostname:
      name: "{{ ansible_hostname }}"

  - name: update hosts file
    template:
      src: etc_hosts.j2
      dest: /etc/hosts
      mode: 0644
      owner: root
      group: root

  roles:
  - { role: server-nagios }

# ---
- hosts: srv-test

  tasks:
  - name: wait for server to be ready
    wait_for: host={{hostvars['srv-mon']["ansible_ssh_host"]}} port=80

  - name: check for nagios webpage asking for password
    action: uri url=http://{{hostvars['srv-mon']["ansible_ssh_host"]}}/nagios return_content=yes status_code=401
    register: webpage
